<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>View - BonsaiDb User&#x27;s Guide</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">About BonsaiDb</li><li class="chapter-item expanded "><a href="../../about/concepts.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../about/concepts/document.html"><strong aria-hidden="true">1.1.</strong> Document</a></li><li class="chapter-item expanded "><a href="../../about/concepts/collection.html"><strong aria-hidden="true">1.2.</strong> Collection</a></li><li class="chapter-item expanded "><a href="../../about/concepts/view.html" class="active"><strong aria-hidden="true">1.3.</strong> View</a></li><li class="chapter-item expanded "><a href="../../about/concepts/schema.html"><strong aria-hidden="true">1.4.</strong> Schema</a></li><li class="chapter-item expanded "><a href="../../about/concepts/database.html"><strong aria-hidden="true">1.5.</strong> Database</a></li><li class="chapter-item expanded "><a href="../../about/concepts/server.html"><strong aria-hidden="true">1.6.</strong> Server</a></li><li class="chapter-item expanded "><a href="../../about/concepts/client.html"><strong aria-hidden="true">1.7.</strong> Client</a></li><li class="chapter-item expanded "><a href="../../about/concepts/pubsub.html"><strong aria-hidden="true">1.8.</strong> PubSub</a></li></ol></li><li class="chapter-item expanded "><a href="../../about/access_models.html"><strong aria-hidden="true">2.</strong> How can BonsaiDb be accessed?</a></li><li class="chapter-item expanded affix "><li class="part-title">Integration</li><li class="chapter-item expanded "><a href="../../integration/overview.html"><strong aria-hidden="true">3.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../integration/local.html"><strong aria-hidden="true">4.</strong> Local</a></li><li class="chapter-item expanded "><a href="../../integration/server.html"><strong aria-hidden="true">5.</strong> Networked</a></li><li class="chapter-item expanded "><a href="../../integration/cluster.html"><strong aria-hidden="true">6.</strong> Clustered (upcoming)</a></li><li class="chapter-item expanded affix "><li class="part-title">Core Traits</li><li class="chapter-item expanded "><a href="../../traits/connection.html"><strong aria-hidden="true">7.</strong> Connection</a></li><li class="chapter-item expanded "><a href="../../traits/server_connection.html"><strong aria-hidden="true">8.</strong> ServerConnection</a></li><li class="chapter-item expanded "><a href="../../traits/pubsub.html"><strong aria-hidden="true">9.</strong> PubSub/Subscriber</a></li><li class="chapter-item expanded "><a href="../../traits/kv.html"><strong aria-hidden="true">10.</strong> Kv</a></li><li class="chapter-item expanded affix "><li class="part-title">Administration</li><li class="chapter-item expanded "><a href="../../administration/permissions.html"><strong aria-hidden="true">11.</strong> Permissions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../administration/permission-statements.html"><strong aria-hidden="true">11.1.</strong> Permission Statements</a></li><li class="chapter-item expanded "><a href="../../administration/rbac.html"><strong aria-hidden="true">11.2.</strong> Users, Groups, and Roles</a></li></ol></li><li class="chapter-item expanded "><a href="../../administration/encryption.html"><strong aria-hidden="true">12.</strong> At-Rest Encryption</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">BonsaiDb User&#x27;s Guide</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="view"><a class="header" href="#view">View</a></h1>
<p>A <a href="https://bonsaidb.dev/main/bonsaidb/core/schema/trait.View.html">View</a> is a <a href="https://en.wikipedia.org/wiki/MapReduce">map/reduce</a>-powered method of quickly accessing information inside of a <a href="./collection.html">Collection</a>. A View can only belong to one Collection.</p>
<p>Views define two important associated types: a Key type and a Value type. You can think of these as the equivalent entries in a map/dictionary-like collection that supports more than one entry for each Key. The Key is used to filter the View's results, and the Value is used by your application or the <code>reduce()</code> function.</p>
<p>Views are a powerful, yet abstract concept. Let's look at a concrete example: blog posts with categories.</p>
<pre><code class="language-rust no_run noplayground">#[derive(Serialize, Deserialize, Debug)]
pub struct BlogPost {
    pub title: String,
    pub body: String,
    pub category: Option&lt;String&gt;,
}
</code></pre>
<p>While <code>category</code> should be an enum, let's first explore using <code>String</code> and upgrade to an enum at the end (it requires one additional step). Let's implement a View that will allow users to find blog posts by their category as well as count the number of posts in each category.</p>
<pre><code class="language-rust noplayground no_run">pub trait BlogPostsByCategory {
    type Collection = BlogPost;
    type Key = Option&lt;String&gt;;
    type Value = u32;

    fn map(&amp;self, document: &amp;Document&lt;'_&gt;) -&gt; MapResult&lt;Self::Key, Self::Value&gt; {
        let post = document.contents::&lt;BlogPost&gt;()?;
        Ok(Some(document.emit_key_and_value(post.category.clone(), 1)))
    }

    fn reduce(
        &amp;self,
        mappings: &amp;[MappedValue&lt;Self::Key, Self::Value&gt;],
        _rereduce: bool,
    ) -&gt; Result&lt;Self::Value, Error&gt; {
        Ok(mappings.iter().map(|mapping| mapping.value).sum())
    }
}
</code></pre>
<h2 id="map"><a class="header" href="#map">Map</a></h2>
<p>The first line of the <code>map</code> function calls <a href="https://bonsaidb.dev/main/bonsaidb/core/document/struct.Document.html#method.contents"><code>Document::contents()</code></a> to deserialize the stored <code>BlogPost</code>. The second line returns an emitted Key and Value -- in our case a clone of the post's category and the value <code>1_u32</code>. With the map function, we're able to use <a href="https://bonsaidb.dev/main/bonsaidb/core/connection/struct.View.html#method.query"><code>query()</code></a> and <a href="https://bonsaidb.dev/main/bonsaidb/core/connection/struct.View.html#method.query_with_docs"><code>query_with_docs()</code></a>:</p>
<pre><code class="language-rust noplayground no_run">    let rust_posts = db
        .view::&lt;BlogPostsByCategory&gt;()
        .with_key(Some(String::from(&quot;Rust&quot;)))
        .query_with_docs().await?;
</code></pre>
<p>The above queries the <a href="./database.html">Database</a> for all documents in the <code>BlogPost</code> Collection that emitted a Key of <code>Some(&quot;Rust&quot;)</code>.</p>
<h2 id="reduce"><a class="header" href="#reduce">Reduce</a></h2>
<p>The second function to learn about is the <code>reduce()</code> function. It is responsible for turning an array of Key/Value pairs into a single Value. In some cases, BonsaiDb might need to call <code>reduce()</code> with values that have already been reduced one time. If this is the case, <code>rereduce</code> is set to true.</p>
<p>In this example, we're using the built-in <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.sum"><code>Iterator::sum()</code></a> function to turn our Value of <code>1_u32</code> into a single <code>u32</code> representing the total number of documents.</p>
<pre><code class="language-rust noplayground no_run">    let rust_post_count = db
        .view::&lt;BlogPostsByCategory&gt;()
        .with_key(Some(String::from(&quot;Rust&quot;)))
        .reduce().await?;
</code></pre>
<h3 id="understanding-re-reduce"><a class="header" href="#understanding-re-reduce">Understanding Re-reduce</a></h3>
<p>Let's examine this data set:</p>
<table><thead><tr><th>Document ID</th><th>BlogPost Category</th></tr></thead><tbody>
<tr><td>1</td><td>Some(&quot;Rust&quot;)</td></tr>
<tr><td>2</td><td>Some(&quot;Rust&quot;)</td></tr>
<tr><td>3</td><td>Some(&quot;Cooking&quot;)</td></tr>
<tr><td>4</td><td>None</td></tr>
</tbody></table>
<p>When updating views, each view entry is reduced and the value is cached. These are the view entries:</p>
<table><thead><tr><th>View Entry ID</th><th>Reduced Value</th></tr></thead><tbody>
<tr><td>Some(&quot;Rust&quot;)</td><td>2</td></tr>
<tr><td>Some(&quot;Cooking&quot;)</td><td>1</td></tr>
<tr><td>None</td><td>1</td></tr>
</tbody></table>
<p>When a reduce query is issued for a single key, the value can be returned without further processing. But, if the reduce query matches multiple keys, the View's <code>reduce()</code> function will be called with the already reduced values with <code>rereduce</code> set to <code>true</code>. For example, retrieving the total count of blog posts:</p>
<pre><code class="language-rust noplayground no_run">    let total_post_count = db
        .view::&lt;BlogPostsByCategory&gt;()
        .reduce().await?;
</code></pre>
<p>Once BonsaiDb has gathered each of the key's reduced values, it needs to further reduce that list into a single value. To accomplish this, the View's <code>reduce()</code> function to be invoked with <code>rereduce</code> set to <code>true</code>, and with mappings containing:</p>
<table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>
<tr><td>Some(&quot;Rust&quot;)</td><td>2</td></tr>
<tr><td>Some(&quot;Cooking&quot;)</td><td>1</td></tr>
<tr><td>None</td><td>1</td></tr>
</tbody></table>
<p>This produces a final value of 4.</p>
<h2 id="how-does-bonsaidb-make-this-efficient"><a class="header" href="#how-does-bonsaidb-make-this-efficient">How does BonsaiDb make this efficient?</a></h2>
<p>When saving Documents, BonsaiDb does not immediately update related views. It instead notes what documents have been updated since the last time the View was indexed.</p>
<p>When a View is accessed, the queries include an <a href="https://bonsaidb.dev/main/bonsaidb/core/connection/enum.AccessPolicy.html"><code>AccessPolicy</code></a>. If you aren't overriding it, <a href="https://bonsaidb.dev/main/bonsaidb/core/connection/enum.AccessPolicy.html#variant.UpdateBefore"><code>UpdateBefore</code></a> is used. This means that when the query is evaluated, BonsaiDb will first check if the index is out of date due to any updated data. If it is, it will update the View before evaluating the query.</p>
<p>If you're wanting to get results quickly and are willing to accept data that might not be updated, the access policies <a href="https://bonsaidb.dev/main/bonsaidb/core/connection/enum.AccessPolicy.html#variant.UpdateAfter"><code>UpdateAfter</code></a> and <a href="https://bonsaidb.dev/main/bonsaidb/core/connection/enum.AccessPolicy.html#variant.NoUpdate"><code>NoUpdate</code></a> can be used depending on your needs.</p>
<p>If multiple simulataneous queries are being evaluted for the same View and the View is outdated, BonsaiDb ensures that only a single view indexer will execute while both queries wait for it to complete.</p>
<h2 id="using-arbitrary-types-as-a-view-key"><a class="header" href="#using-arbitrary-types-as-a-view-key">Using arbitrary types as a View Key</a></h2>
<p>In our previous example, we used <code>String</code> for the Key type. The reason is important: Keys must be sortable by <a href="http://sled.rs/">our underlying storage engine</a>, which means special care must be taken. Most serialization types do not guarantee binary sort order. Instead, BonsaiDb exposes the <a href="https://bonsaidb.dev/main/bonsaidb/core/schema/trait.Key.html"><code>Key</code></a> trait. On that documentation page, you can see that BonsaiDb implements <code>Key</code> for many built-in types.</p>
<h3 id="using-an-enum-as-a-view-key"><a class="header" href="#using-an-enum-as-a-view-key">Using an enum as a View Key</a></h3>
<p>The easiest way to expose an enum is to derive <a href="https://docs.rs/num-traits/0.2.14/num_traits/cast/trait.FromPrimitive.html"><code>num_traits::FromPrimitive</code></a> and <a href="https://docs.rs/num-traits/0.2.14/num_traits/cast/trait.ToPrimitive.html"><code>num_traits::ToPrimitive</code></a> using <a href="https://lib.rs/num-derive">num-derive</a>, and add an <code>impl EnumKey</code> line:</p>
<pre><code class="language-rust noplayground no_run">#[derive(Serialize, Deserialize, Debug, num_derive::FromPrimitive, num_derive::ToPrimitive)]
pub enum Category {
    Rust,
    Cooking,
}

impl EnumKey for Category {}
</code></pre>
<p>The View code remains unchanged, although the associated Key type can now be set to <code>Option&lt;Category&gt;</code>. The queries can now use the enum instead of a <code>String</code>:</p>
<pre><code class="language-rust noplayground no_run">    let rust_post_count = db
        .view::&lt;BlogPostsByCategory&gt;()
        .with_key(Some(Category::Rust))
        .reduce().await?;
</code></pre>
<p>BonsaiDb will convert the enum to a u64 and use that value as the Key. A u64 was chosen to ensure fairly wide compatibility even with some extreme usages of bitmasks. If you wish to customize this behavior, you can implement <code>Key</code> directly.</p>
<h3 id="implementing-the-key-trait"><a class="header" href="#implementing-the-key-trait">Implementing the <code>Key</code> trait</a></h3>
<p>The <a href="https://bonsaidb.dev/main/bonsaidb/core/schema/trait.Key.html"><code>Key</code></a> trait declares two functions: <a href="https://bonsaidb.dev/main/bonsaidb/core/schema/trait.Key.html#tymethod.as_big_endian_bytes"><code>as_big_endian_bytes()</code></a> and <a href="https://bonsaidb.dev/main/bonsaidb/core/schema/trait.Key.html#tymethod.from_big_endian_bytes"><code>from_big_endian_bytes</code></a>. The intention is to convert the type to bytes using a network byte order for numerical types, and for non-numerical types, the bytes need to be stored in binary-sortable order.</p>
<p>Here is how BonsaiDb implements Key for <code>EnumKey</code>:</p>
<pre><code class="language-rust noplayground no_run">impl&lt;T&gt; Key for T
where
    T: EnumKey,
{
    fn as_big_endian_bytes(&amp;self) -&gt; anyhow::Result&lt;Cow&lt;'_, [u8]&gt;&gt; {
        self.to_u64()
            .ok_or_else(|| anyhow::anyhow!(&quot;Primitive::to_u64() returned None&quot;))?
            .as_big_endian_bytes()
            .map(|bytes| Cow::Owned(bytes.to_vec()))
    }

    fn from_big_endian_bytes(bytes: &amp;[u8]) -&gt; anyhow::Result&lt;Self&gt; {
        let primitive = u64::from_big_endian_bytes(bytes)?;
        Self::from_u64(primitive)
            .ok_or_else(|| anyhow::anyhow!(&quot;Primitive::from_u64() returned None&quot;))
    }
}
</code></pre>
<p>By implementing <code>Key</code> you can take full control of converting your view keys.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../about/concepts/collection.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../about/concepts/schema.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../about/concepts/collection.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../about/concepts/schema.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="../../mermaid.min.js"></script>
                <script type="text/javascript" src="../../mermaid-init.js"></script>
        
        
    </body>
</html>
